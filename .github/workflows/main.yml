name: Build Complete Tailwind CSS

on:
  push:
    branches: [ main, master, localize ]
  workflow_dispatch:

jobs:
  build-css:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Create assets directory
      run: mkdir -p assets src
      
    - name: Download Tailwind CSS standalone
      run: |
        curl -sLo tailwindcss "https://github.com/tailwindlabs/tailwindcss/releases/latest/download/tailwindcss-linux-x64"
        chmod +x tailwindcss
        
    - name: Create comprehensive Tailwind input
      run: |
        cat > src/input.css << 'EOF'
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        @layer utilities {
          .container-max-width { max-width: 48rem; }
          .flex-center { display: flex; align-items: center; justify-content: center; }
          .text-balance { text-wrap: balance; }
          .transition-all { transition: all 0.3s ease; }
          .space-y-4 > * + * { margin-top: 1rem; }
          .space-y-6 > * + * { margin-top: 1.5rem; }
          .space-x-4 > * + * { margin-left: 1rem; }
          .gap-4 { gap: 1rem; }
          .gap-6 { gap: 1.5rem; }
          .rounded-xl { border-radius: 0.75rem; }
          .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
          .backdrop-blur { backdrop-filter: blur(8px); }
        }
        EOF
        
    - name: Create comprehensive Tailwind config
      run: |
        cat > tailwind.config.js << 'EOF'
        module.exports = {
          content: [
            "./index.html",
            "./temp-classes.html"
          ],
          theme: {
            extend: {
              fontFamily: {
                'inter': ['Inter', 'sans-serif'],
              },
              colors: {
                'primary': 'var(--color-primary)',
                'on-primary': 'var(--color-on-primary)',
                'primary-container': 'var(--color-primary-container)',
                'on-primary-container': 'var(--color-on-primary-container)',
                'secondary': 'var(--color-secondary)',
                'on-secondary': 'var(--color-on-secondary)',
                'secondary-container': 'var(--color-secondary-container)',
                'on-secondary-container': 'var(--color-on-secondary-container)',
                'surface': 'var(--color-surface)',
                'on-surface': 'var(--color-on-surface)',
                'surface-variant': 'var(--color-surface-variant)',
                'on-surface-variant': 'var(--color-on-surface-variant)',
                'background': 'var(--color-background)',
                'on-background': 'var(--color-on-background)',
                'outline': 'var(--color-outline)',
                'outline-variant': 'var(--color-outline-variant)',
              }
            },
          },
          plugins: [],
          safelist: [
            'container', 'mx-auto', 'p-4', 'p-6', 'py-4', 'px-4', 'py-6', 'px-6',
            'mt-4', 'mt-6', 'mt-16', 'mb-4', 'mb-6', 'ml-4', 'mr-4',
            'w-full', 'w-auto', 'h-full', 'h-auto', 'min-h-screen',
            'flex', 'flex-col', 'flex-row', 'items-center', 'justify-center', 'justify-between',
            'grid', 'grid-cols-1', 'grid-cols-2', 'grid-cols-3', 'gap-4', 'gap-6',
            'text-center', 'text-left', 'text-right',
            'text-sm', 'text-base', 'text-lg', 'text-xl', 'text-2xl', 'text-3xl',
            'font-normal', 'font-medium', 'font-semibold', 'font-bold',
            'bg-transparent', 'bg-white', 'bg-gray-50', 'bg-gray-100', 'bg-gray-900',
            'text-white', 'text-gray-600', 'text-gray-700', 'text-gray-900',
            'border', 'border-gray-200', 'border-gray-300', 'rounded', 'rounded-lg', 'rounded-xl', 'rounded-full',
            'shadow', 'shadow-sm', 'shadow-md', 'shadow-lg',
            'hover:bg-gray-50', 'hover:bg-gray-100', 'hover:shadow-lg',
            'transition', 'transition-all', 'duration-200', 'duration-300',
            'opacity-0', 'opacity-50', 'opacity-100',
            'hidden', 'block', 'inline-block', 'inline-flex',
            'relative', 'absolute', 'fixed', 'top-0', 'bottom-0', 'left-0', 'right-0',
            'z-10', 'z-20', 'z-30', 'z-40', 'z-50',
            'cursor-pointer', 'pointer-events-none',
            'select-none', 'user-select-none',
            'overflow-hidden', 'overflow-auto', 'overflow-y-auto',
            'max-w-md', 'max-w-lg', 'max-w-xl', 'max-w-2xl', 'max-w-4xl'
          ]
        }
        EOF
        
    - name: Generate sample HTML for class scanning
      run: |
        cat > temp-classes.html << 'EOF'
        <html><body>
        <div class="container mx-auto max-w-4xl p-4 py-6 px-6">
          <div class="flex flex-col items-center justify-center space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div class="bg-white bg-surface bg-surface-variant rounded-lg rounded-xl shadow-md shadow-lg p-6">
                <h2 class="text-xl text-2xl font-bold font-semibold text-primary mb-4">Title</h2>
                <p class="text-gray-600 text-on-surface-variant mb-6">Text</p>
                <button class="btn bg-primary text-on-primary hover:bg-primary-container px-6 py-3 rounded-full transition-all">Button</button>
              </div>
            </div>
          </div>
        </div>
        <nav class="fixed top-0 left-0 w-full bg-primary-container z-50">
          <div class="flex justify-between items-center p-4">
            <span class="material-symbols-outlined text-on-primary-container">menu</span>
          </div>
        </nav>
        <div class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center">
          <div class="bg-surface rounded-xl p-6 max-w-lg w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-on-surface">Modal</h3>
            </div>
          </div>
        </div>
        </body></html>
        EOF
        
    - name: Build comprehensive Tailwind CSS
      run: |
        echo "–°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—É—é —Å–±–æ—Ä–∫—É Tailwind CSS..."
        ./tailwindcss -i ./src/input.css -o ./assets/tailwind.min.css --minify
        
        if [ -f assets/tailwind.min.css ]; then
          echo "‚úÖ –ü–æ–ª–Ω—ã–π CSS —Å–æ–∑–¥–∞–Ω –≤ assets/tailwind.min.css"
          echo "üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:"
          ls -lh assets/tailwind.min.css
        else
          echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è CSS —Ñ–∞–π–ª–∞"
          exit 1
        fi
        
    - name: Update HTML with hybrid loading
      run: |
        python3 << 'EOF'
        import re
        
        with open('index.html', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ CSS
        content = re.sub(r'<link rel="stylesheet" href="\./assets/tailwind\.min\.css">', '', content)
        content = re.sub(r'<link rel="stylesheet" href="\./css/tailwind\.min\.css">', '', content)
        
        # –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω–µ—Ü –ø–µ—Ä–≤–æ–≥–æ script –±–ª–æ–∫–∞
        first_script_end = content.find('</script>')
        if first_script_end != -1:
            insert_pos = first_script_end + len('</script>')
            
            hybrid_css = '''

<!-- –ì–∏–±—Ä–∏–¥–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Tailwind CSS -->
<script>
  function loadCSS(href, onSuccess, onError) {
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = href;
    link.onload = onSuccess || function() {};
    link.onerror = onError || function() {};
    document.head.appendChild(link);
    return link;
  }

  loadCSS("./assets/tailwind.min.css", 
    function() { console.log("‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π Tailwind CSS –∑–∞–≥—Ä—É–∂–µ–Ω"); },
    function() {
      console.warn("‚ö†Ô∏è –õ–æ–∫–∞–ª—å–Ω—ã–π CSS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–≥—Ä—É–∂–∞—é CDN...");
      loadCSS("https://cdn.tailwindcss.com", 
        function() { console.log("‚úÖ Tailwind CSS –∑–∞–≥—Ä—É–∂–µ–Ω —Å CDN"); },
        function() { console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Tailwind CSS"); }
      );
    }
  );
</script>'''
            
            content = content[:insert_pos] + hybrid_css + content[insert_pos:]
            print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≥–∏–±—Ä–∏–¥–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ CSS")
        
        with open('index.html', 'w', encoding='utf-8') as f:
            f.write(content)
        EOF
        
    - name: Cleanup and verify
      run: |
        rm -f tailwindcss temp-classes.html
        
        echo "üìä –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ CSS —Ñ–∞–π–ª–∞:"
        head -5 assets/tailwind.min.css
        echo ""
        echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:"
        du -h assets/tailwind.min.css
        
    - name: Check changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: 'üé® –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—É—é —Å–±–æ—Ä–∫—É Tailwind CSS —Å –≥–∏–±—Ä–∏–¥–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π [skip ci]'
        file_pattern: 'assets/tailwind.min.css src/input.css tailwind.config.js index.html'
        commit_user_name: 'GitHub Action'
        commit_user_email: 'action@github.com'
